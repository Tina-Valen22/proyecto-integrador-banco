{% extends "base.html" %}
{% block title %}Categorías{% endblock %}

{% block content %}
<h1>Categorías</h1>

<h2>Gestionar Categoría</h2>

<form method="post"
      id="categoriaForm"
      action="/categorias/crear"
      onsubmit="return validarCategoria()">

    <!-- ID oculto: si viene, se edita; si no, se crea -->
    <input type="hidden" name="idCategoria" id="idCategoria">

    <div class="form-row">
        <label for="nombre">Nombre de la categoría *</label>
        <input type="text"
               name="nombre"
               id="nombre"
               placeholder="Ej: Hipotecario, Consumo, Vehículo..."
               required>
    </div>

    <div class="form-row">
        <label for="descripcion">Descripción *</label>
        <textarea name="descripcion"
                  id="descripcion"
                  rows="3"
                  placeholder="Describe brevemente la categoría"
                  required></textarea>
    </div>

    <div class="form-row">
        <label for="credito_id">Crédito asociado *</label>
        <select name="credito_id" id="credito_id" required>
            <option value="">-- Seleccione un crédito --</option>
            {% for cr in creditos %}
            <option value="{{ cr.idCredito }}">
                Crédito {{ cr.idCredito }} - {{ cr.tipo }} - Monto: {{ cr.monto }}
            </option>
            {% endfor %}
        </select>
    </div>

    <div class="form-actions">
        <button type="submit">Guardar</button>
        <button type="button" onclick="prepararNuevaCategoria()">Limpiar / Nuevo</button>
    </div>
</form>

<hr>

<h2>Lista de Categorías</h2>
<table>
    <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Descripción</th>
        <th>Crédito asociado</th>
        <th>Acciones</th>
    </tr>
    {% for c in categorias %}
    <tr>
        <td>{{ c.idCategoria }}</td>
        <td>{{ c.nombre }}</td>
        <td>{{ c.descripcion }}</td>
        <td>
            {% set cid = cat_creditos.get(c.idCategoria) %}
            {% if cid %}
                {{ cid }}
            {% else %}
                Sin asignar
            {% endif %}
        </td>
        <td>
            <button type="button"
                    onclick="cargarCategoriaDesdeFila(this)"
                    data-id="{{ c.idCategoria }}"
                    data-nombre="{{ c.nombre }}"
                    data-descripcion="{{ c.descripcion or '' }}"
                    data-credito_id="{{ cat_creditos.get(c.idCategoria, '') }}">
                Editar
            </button>
        </td>
    </tr>
    {% endfor %}
</table>

<script>
function prepararNuevaCategoria() {
    const form = document.getElementById('categoriaForm');
    form.reset();
    document.getElementById('idCategoria').value = '';
    form.action = '/categorias/crear';
}

function cargarCategoriaDesdeFila(btn) {
    const form = document.getElementById('categoriaForm');

    const id = btn.dataset.id;
    const nombre = btn.dataset.nombre || '';
    const descripcion = btn.dataset.descripcion || '';
    const creditoId = btn.dataset.credito_id || '';

    document.getElementById('idCategoria').value = id;
    document.getElementById('nombre').value = nombre;
    document.getElementById('descripcion').value = descripcion;

    if (creditoId) {
        document.getElementById('credito_id').value = creditoId;
    } else {
        document.getElementById('credito_id').value = '';
    }

    form.action = '/categorias/actualizar';
}

function validarCategoria() {
    const nombre = document.getElementById('nombre').value.trim();
    const descripcion = document.getElementById('descripcion').value.trim();
    const creditoId = document.getElementById('credito_id').value;

    if (!nombre) {
        alert('El nombre de la categoría es obligatorio.');
        return false;
    }

    if (!descripcion) {
        alert('La descripción es obligatoria.');
        return false;
    }

    if (!creditoId) {
        alert('Debe seleccionar un crédito asociado.');
        return false;
    }

    return true;
}
</script>
{% endblock %}